name: Upload Python Package

on:
  release:
    types: [created]
  workflow_dispatch:

jobs:
  deploy:
    runs-on: ubuntu-latest
    steps:
    - uses: actions/checkout@master
    - name: Set up Python 3.10
      uses: actions/setup-python@v3
      with:
        python-version: "3.10"
        
    - name: Install poetry and basic tools
      run: |
        python -m pip install --upgrade pip
        pip install poetry
    - name: Configure poetry
      run: |
        python -m poetry config virtualenvs.in-project true    
        
    - name: Cache the vitual env
      uses: actions/cache@v3
      with:
        path: ./.venv
        key: ${{ runner.os }}-venv-${{ hashFiles('**/poetry.lock') }}

    - name: Install dependencies
      run: |
        python -m poetry install

    - name: Run tests
      run: |
        python -m poetry run python -m pytest -sxv
    - name: Build docs
      run: |
        python -m poetry run python -m sphinx-build ./docs/source ./docs/build -a
    - name: Build and publish
      env:
        PYPI_TOKEN: ${{ secrets.PYPI_PASSWORD }}
      run: |
        poetry config pypi-token.pypi $PYPI_TOKEN
        poetry build
